Data Race lÃ  gÃ¬?
Thá»±c cháº¥t lÃ  mÃ¬nh khÃ´ng nghÄ© ra â€œlÃ  cÃ³ khÃ¡i niá»‡m Data raceâ€œ, vÃ¬ trong khi Ä‘Ã£ cÃ³ khÃ¡i niá»‡m Race Condition rá»“i. VÃ  trong quÃ¡ trÃ¬nh Ä‘á»c thÃªm cÃ¡c sÃ¡ch, bÃ¡o, tÃ i liá»‡u â€¦ nÃ³ láº¡i Ä‘Æ°á»£c Ä‘á» cáº­p tá»›i vÃ i láº§n. Sau khi vÃ i Ä‘Æ°á»ng Google thÃ¬ cáº£ má»™t chÃ¢n trá»i kiáº¿n thá»©c hiá»‡n ra. Tuy nhiÃªn, 2 khÃ¡i niá»‡m khÃ¡ lÃ  ráº¯c rá»‘i vÃ  dÃ¢y mÆ¡ rá»… mÃ¡ vá»›i nhau ráº¥t nhiá»u.

MÃ¬nh sáº½ sá»­ dá»¥ng vÃ  trÃ­ch dáº«n khÃ¡ nhiá»u trong bÃ i viáº¿t nÃ y. Hi vá»ng báº¡n sáº½ hiá»ƒu Ä‘Æ°á»£c, cÃ²n khÃ´ng hiá»ƒu thÃ¬ khÃ´ng sao. Chá»‰ cáº§n thÃ´ng Ä‘Æ°á»£c 2 pháº§n cuá»‘i cá»§a bÃ i viáº¿t lÃ  á»•n rá»“i.

KhÃ¡i niá»‡m
Data Race xáº£y ra khi cÃ³ tá»« 2 thread trá»Ÿ lÃªn cÃ¹ng truy cáº­p vÃ o má»™t vÃ¹ng nhá»› chung (shared resource) vá»›i Ã­t nháº¥t 1 thread thá»±c hiá»‡n viá»‡c thay Ä‘á»•i giÃ¡ trá»‹ trÃªn vÃ¹ng nhá»› Ä‘Ã³.

Äá»c qua thÃ¬ nÃ³ cÅ©ng giá»‘ng khÃ¡i niá»‡m Race Condition. ChÃºng ta sáº½ phÃ¢n tÃ­ch 2 má»‘i quan há»‡ Ä‘Ã³ á»Ÿ pháº§n sau.

Äiá»u kiá»‡n Ä‘á»ƒ Data Race xáº£y ra nhÆ° sau:

CÃ³ tá»« 2 thread trá»Ÿ lÃªn cÃ¹ng truy cáº­p vÃ o shared resource (dá»¯ liá»‡u dÃ¹ng chung) Ä‘á»ƒ Ä‘á»c hoáº·c ghi. Cá»¥ thá»ƒ shared resource lÃ  1 variable hoáº·c 1 object.
CÃ³ Ã­t nháº¥t 1 thread thay Ä‘á»•i giÃ¡ trá»‹ cá»§a variable hoáº·c object Ä‘Ã³. Náº¿u táº¥t cáº£ thread chá»‰ Ä‘á»c dá»¯ liá»‡u sáº½ khÃ´ng xáº£y ra data race.
VÃ­ dá»¥
Trong thá»±c táº¿, vÃ­ dá»¥ cá»§a data race lÃ  bÃ i toÃ¡n kinh Ä‘iá»ƒn rÃºt tiá»n táº¡i cÃ¢y ATM. Giáº£ sá»­ cÃ³ 1 tháº» ATM vÃ  1 tháº» Visa Debit cÃ¹ng link Ä‘áº¿n 1 tÃ i khoáº£n ngÃ¢n hÃ ng vÃ  Ä‘i rÃºt tiá»n cÃ¹ng lÃºc. Trong tÃ i khoáº£n cÃ²n 50k vá»«a Ä‘á»§ lÃ m bÃ¡t bÃºn real cool vÃ  cá»‘c trÃ  Ä‘Ã¡. MÃ¬nh Ä‘á»“ng thá»i rÃºt á»Ÿ cáº£ 2 mÃ¡y ATM 50k. Náº¿u khÃ´ng xá»­ lÃ½ data race, mÃ¬nh sáº½ may máº¯n rÃºt Ä‘Æ°á»£c tá»•ng cá»™ng 100k á»Ÿ cáº£ 2 mÃ¡y.

(trÃ­ch dáº«n tá»« bÃ i viáº¿t táº¡i Viblo)

Giáº£i phÃ¡p
Khi cÃ³ nhiá»u thread cÃ¹ng Ä‘á»c vÃ  ghi vÃ o shared resource, xÃ¡c suáº¥t xáº£y ra data race ráº¥t cao. NÃªn viá»‡c giáº£i quyáº¿t váº¥n Ä‘á» nÃ y cÅ©ng khÃ¡ lÃ  Ä‘Æ¡n giáº£n.

Ta cáº§n Ä‘áº£m báº£o chá»‰ duy nháº¥t 1 thread Ä‘Æ°á»£c truy cáº­p vÃ o shared resource táº¡i má»™t thá»i Ä‘iá»ƒm.
Tá»«ng thread sáº½ thay phiÃªn nhau thao tÃ¡c vá»›i shared resource.
HÃ nh Ä‘á»™ng cá»© liÃªn tá»¥c láº·p láº¡i cho Ä‘áº¿n khi táº¥t cáº£ Ä‘Æ°á»£c thoáº£ mÃ£n.
Trong láº­p trÃ¬nh, Ä‘oáº¡n code dÃ¹ng Ä‘á»ƒ read/write shared resource gá»i lÃ  critical section/critical region.

Viá»‡c thay phiÃªn nhau sá»­ dá»¥ng critical section lÃ  cÆ¡ cháº¿ Ä‘á»ƒ xá»­ lÃ½ Data Race, gá»i lÃ  mutex. Hay cÃ²n gá»i lÃ  mutual exclusion.

Chuá»—i hÃ nh Ä‘á»™ng Ä‘Ã³ Ä‘Æ°á»£c gá»i lÃ  atomic operation vá»›i cÃ¡c Ä‘áº·c tÃ­nh:

Thá»±c thi nhÆ° má»™t thao tÃ¡c duy nháº¥t.
QuÃ¡ trÃ¬nh thá»±c thi khÃ´ng bá»‹ giÃ¡n Ä‘oáº¡n bá»Ÿi báº¥t kÃ¬ thread nÃ o.
VÃ  báº¡n cÅ©ng pháº£i chÃº Ã½ tá»›i váº¥n dá» Dead Lock khi khoÃ¡ mÃ£i mÃ£i.

Data Race vs. Race Condition
Pháº§n lÃ½ thuyáº¿t trÃªn Ä‘Ã£ khÃ¡ lÃ  mÆ¡ há»“ rá»“i. Giá» chÃºng ta láº¡i tiáº¿p tá»¥c loáº¡n nÃ£o tiáº¿p vá»›i pháº§n so sÃ¡ch giá»¯a chÃºng.

So sÃ¡nh


Hai váº¥n Ä‘á» Data Race vÃ  Race Condition hay bá»‹ Ä‘Ã¡nh Ä‘á»“ng lÃ  má»™t (cÃ³ láº½ vÃ¬ cÃ¹ng tá»« race). Tuy nhiÃªn nÃ³ diá»…n táº£ hai váº¥n Ä‘á» khÃ¡c nhau trong láº­p trÃ¬nh multi-thread.

Race Condition

Sáº½ táº­p trung vÃ o thá»© tá»± thá»±c thi cá»§a cÃ¡c thread.
Váº¥n Ä‘á» sai sÃ³t vá» máº·t thá»i gian hoáº·c thá»© tá»± thá»±c thi cá»§a cÃ¡c thread trong chÆ°Æ¡ng trÃ¬nh khiáº¿n cho káº¿t quáº£ cuá»‘i cÃ¹ng khÃ´ng Ä‘Ãºng nhÆ° mong muá»‘n.
Data Race

Táº­p trung vÃ o máº·t giÃ¡ trá»‹ cá»§a dá»¯ liá»‡u
CÃ¡c giÃ¡ trá»‹ bá»‹ ghi Ä‘Ã¨ láº«n nhau. Dáº«n tá»›i viá»‡c Ä‘á»c giÃ¡ trá»‹ sáº½ bá»‹ sai.
Vá» cÃ¡c giáº£i quyáº¿t 2 váº¥n Ä‘á» nÃ y thÃ¬ khÃ¡ giá»‘ng nhau. Chá»‰ cáº§n Ä‘áº£m báº£o má»™t thread Ä‘Æ°á»£c truy cáº­p vÃ o critical section táº¡i má»™t thá»i Ä‘iá»ƒm.

Má»‘i quan há»‡
Trong thá»±c táº¿, Race Condition xáº£y ra do Data Race vÃ  Data Race dáº«n Ä‘áº¿n Race Condition. KhÃ´ng khÃ¡c nhau láº¯m nhá»‰, tuy nhiÃªn hai váº¥n Ä‘á» nÃ y khÃ´ng phá»¥ thuá»™c vÃ o nhau.

Má»™t chÆ°Æ¡ng trÃ¬nh cÃ³ thá»ƒ cÃ³ data race mÃ  khÃ´ng cÃ³ race condition.
Hoáº·c cÃ³ race condition mÃ  khÃ´ng cÃ³ data race.
Ta hÃ£y xem má»™t vÃ­ dá»¥ nhÆ° sau.

let concurrentQueue = DispatchQueue(label: "com.fx.queue1", attributes: .concurrent)
var number = 1
concurrentQueue.async {
    let temp = self.number
    self.number += 2
    print("#1: \(temp) + 2")
}
// Thread 2
concurrentQueue.async {
    let temp = self.number
    self.number *= 3
    print("#2: \(temp) * 3")
}
DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
    print(self.number)
}
ÄÃ¢y lÃ  vÃ­ dá»¥ cho viá»‡c thá»±c hiá»‡n má»™t biá»ƒu thá»©c Ä‘Æ¡n giáº£n lÃ  1 + 2 * 3. Báº¡n hÃ£y thá»­ cháº¡y nhiá»u láº§n Ä‘oáº¡n káº¿t trÃªn, thÃ¬ sáº½ tháº¥y káº¿t quáº£ ráº¥t báº¥t ngá».





Báº¡n cÅ©ng dá»… dÃ ng nháº­n tháº¥y káº¿t quáº£ cá»§a cÃ¡c láº§n cháº¡y khÃ¡c nhau (9 & 5). ÄÃ³ cÅ©ng lÃ  thá»© tá»± mÃ  báº¡n thá»±c hiá»‡n biá»ƒu thá»©c 1 + 2 * 3.

Náº¿u nhÃ¢n chia trÆ°á»›c thÃ¬ sáº½ lÃ  5
Náº¿u cá»™ng trá»« trÆ°á»›c thÃ¬ sáº½ lÃ  9
ÄÃºng lÃ  Magic pháº£i khÃ´ng nÃ o!

CÃ¡c trÆ°á»ng há»£p khÃ¡c
Tuy tá»¥i nÃ³ cÃ³ má»‘i quan há»‡ tÆ°Æ¡ng há»— láº§n nhau. Tuy nhiÃªn, cÃ³ nhiá»u trÆ°á»ng há»£p cÃ³ cÃ¡i nÃ y khÃ´ng cÃ³ cÃ¡i kia. MÃ¬nh cÃ³ thá»ƒ tÃ³m táº¯t nhÆ° sau:

CÃ³ Data Race dáº«n tá»›i Race Condition.
(vÃ­ dá»¥ trÃªn nha)

CÃ³ Race Condition mÃ  khÃ´ng cÃ³ Data Race
Xem vÃ­ dá»¥ sau nha:

concurrentQueue.async {
    for i in 1...10 {
        print("ğŸ”´ \(i)")
    }
}
concurrentQueue.async {
    for i in 1...10 {
        print("ğŸ”µ \(i)")
    }
}
ÄÆ¡n giáº£n lÃ  chÃºng nÃ³ máº¡nh ai náº¥y cháº¡y. Náº¿u báº¡n suy nghÄ© vá» thá»© tá»± láº§n lÆ°á»£t cá»§a cÃ¡c thread, thÃ¬ Ä‘Ã¢y sáº½ rÆ¡i vÃ o Race Condition vÃ  khÃ´ng cÃ³ áº£nh hÆ°á»Ÿng nÃ o tá»›i dá»¯ liá»‡u háº¿t.

CÃ³ Data Race mÃ  khÃ´ng cÃ³ Race Condition
Báº¡n xem qua vÃ­ dá»¥ nÃ y nha.

var unsafeNumber: Int = 0
DispatchQueue.concurrentPerform(iterations: 100) { i in
    print("#\(i) : \(Thread.current)")
    unsafeNumber = i
}
print(unsafeNumber)
Má»—i láº§n thá»±c thi, báº¡n sáº½ nháº­n Ä‘Æ°á»£c má»™t káº¿t quáº£ khÃ¡c nhau. NguyÃªn nhÃ¢n chÃ­nh lÃ  DispatchQueue.concurrentPerform, nÃ³ thá»±c thi Ä‘oáº¡n code trÃªn nhá»¯ng Thread khÃ¡c nhau. Sá»‘ lÆ°á»£ng cÃ¡c Thread tuá»³ thuá»™c vÃ o há»‡ thá»‘ng quyáº¿t Ä‘á»‹nh.

CÃ¡c Thread nÃ y cÃ¹ng nhau thay Ä‘á»•i giÃ¡ trá»‹ cá»§a number. Háº§u nhÆ° má»i thá»© diá»…n ra tá»©c thá»i vá»›i nhau. KhÃ´ng cÃ³ sá»± xung Ä‘á»™t giá»¯a cÃ¡c Thread. Hay cÃ¡i nÃ y áº£nh hÆ°á»Ÿng cÃ¡i kia. Do Ä‘Ã³, hiá»‡n tÆ°á»£ng Race Condition háº§u nhÆ° khÃ´ng xáº£y ra.

Tuy nhiÃªn, Ä‘Ã³ chá»‰ lÃ  suy nghÄ© chá»§ quan cá»§a mÃ¬nh khi cá»‘ tÃ¬m ra vÃ­ dá»¥ cho báº¡n dá»… hiá»ƒu. CÃ²n náº¿u dá»… hiá»ƒu hÆ¡n lÃ  bÃ i toÃ¡n ATM á»Ÿ trÃªn. MÃ  mÃ¬nh cÅ©ng khÃ´ng thá»ƒ cÃ i Ä‘áº·t hay thá»±c thi 2 chÆ°Æ¡ng trÃ¬nh cÃ¹ng tÆ°Æ¡ng tÃ¡c tá»›i 1 database. NÃªn ta táº¡m xem nÃ³ lÃ  lÃ½ thuyáº¿t váº­y.

Thread safety
Tá»« váº¥n Ä‘á» Data Race trÃªn, cá»™ng vá»›i ngÃ´n ngá»¯ mÃ  chÃºng ta Ä‘ang sá»­ dá»¥ng lÃ  Swift. Vá»›i Swift, háº§u háº¿t cÃ¡c kiá»ƒu dá»¯ liá»‡u cá»§a nÃ³ máº·c Ä‘á»‹nh sáº½ khÃ´ng an toÃ n cho thread.

CÃ¡c Thread cÃ³ thá»ƒ thoáº£ mÃ¡i truy cáº­p Ä‘á»c/ghi giÃ¡ trá»‹ lÃªn cÃ¡c biáº¿n dÃ¹ng chung trong chÆ°Æ¡ng trÃ¬nh.

VÃ¬ váº­y, Ä‘á»ƒ triá»‡t tiÃªu triá»‡t Ä‘á»ƒ Data Race & Race Condition, thÃ¬ báº¡n pháº£i cÃ³ Ä‘Æ°á»£c Thread Safety Ä‘á»ƒ sá»­ dá»¥ng thÆ°á»ng xuyÃªn. ChÃºng sáº½ Ä‘áº£m báº£o viá»‡c thá»±c hiá»‡n theo Serial Queue hoáº·c Lock Thread.

VÃ­ dá»¥
Báº¡n xem qua vÃ­ dá»¥ code sau (lÃ  nÃ¢ng cáº¥p cá»§a vÃ­ dá»¥ trÃªn). Nhiá»‡m vá»¥ cá»§a nÃ³ lÃ  lÆ°u láº¡i tÃªn cá»§a cÃ¡c Thread.

var threads: [Int: String] = [:]
DispatchQueue.concurrentPerform(iterations: 100) { i in
    threads[i] = "\(Thread.current)"
}
print(threads)
Báº¡n thá»±c thi thÃ¬ sáº½ bá»‹ crash ngay. ÄÃ³ chÃ­nh lÃ  há»‡ quáº£ cá»§a Data Race gÃ¢y ra. Khi dá»¯ liá»‡u bá»‹ sá»­a Ä‘á»•i liÃªn tá»¥c vÃ  Ä‘á»“ng thá»i, dáº«n tá»›i sá»± tranh cháº¥p nhau giá»¯a nhiá»u Thread. VÃ  chÆ°Æ¡ng trÃ¬nh sáº½ ngá»§m cá»§ tá»i.

Giáº£i phÃ¡p
Báº¡n cÃ³ thá»ƒ Ã¡p dá»¥ng cÃ¡c giáº£i phÃ¡p trÆ°á»›c Ä‘Ã¢y cá»§a Race Condition. NhÆ°ng á»Ÿ Ä‘Ã¢y chÃºng ta sáº½ cá»‘ táº¡o ra má»™t Thread Safety, nháº±m giÃºp cho dá»¯ liá»‡u cá»§a báº¡n Ä‘Æ°á»£c an toÃ n trong cÃ¡c Thread.

Váº«n lÃ  vÃ­ dá»¥ trÃªn, láº§n nÃ y báº¡n sáº½ giáº£i quyáº¿t chÃºng báº±ng GCD nhÆ° sau.

var threads: [Int: String] = [:]
let lockQueue = DispatchQueue(label: "my.serial.lock.queue")
DispatchQueue.concurrentPerform(iterations: 100) { i in
    lockQueue.sync {
        threads[i] = "\(Thread.current)"
    }
}
print(threads)
ChÃ¬a khoÃ¡ chÃ­nh lÃ  Serial Queue (critical section). NÃ³ Ä‘áº£m báº£o viá»‡c ghi dá»¯ liá»‡u lÃ  duy nháº¥t. CÃ¡c thread khÃ¡c nhau sáº½ láº§n lÆ°á»£t sá»­ dá»¥ng nÃ³.

VÃ  táº¥t nhiÃªn, báº¡n khÃ´ng thá»ƒ lÃºc nÃ o cÅ©ng khai bÃ¡o thÃªm 1 Serial Queue vÃ  pháº£i ghi nhá»› viá»‡c sá»­ dá»¥ng serialQueue.sync bá»c láº¡i cÃ¡c Ä‘oáº¡n code nhÆ° váº­y. Ta sáº½ nÃ¢ng cáº¥p chÃºng thÃ nh má»™t class xá»‹n sÃ² hÆ¡n.

Atomic Class
Báº¡n xem tiáº¿p vÃ­ dá»¥ cho custom class má»›i nha.

import Foundation
import Dispatch
class AtomicStorage {
    private let lockQueue = DispatchQueue(label: "my.serial.lock.queue")
    private var storage: [Int: String]
    
    init() {
        self.storage = [:]
    }
        
    func get(_ key: Int) -> String? {
        lockQueue.sync {
            storage[key]
        }
    }
    
    func set(_ key: Int, value: String) {
        lockQueue.sync {
            storage[key] = value
        }
    }
    var allValues: [Int: String] {
        lockQueue.sync {
            storage
        }
    }
}
Trong Ä‘Ã³:

CÃ¡c thuá»™c tÃ­nh vÃ  phÆ°Æ¡ng thá»©c cá»§a lá»›p váº«n khai bÃ¡o bÃ¬nh thÆ°á»ng
ThÃªm má»™t Serial Queue, vá»›i vai trÃ² lÃ  cÆ¡ cháº¿ khoÃ¡
Sáº½ triá»‡u há»“i thÃªm .sync cho cÃ¡c thao tÃ¡c Ä‘á»c/ghi vá»›i dá»¯ liá»‡u
CÃ¡c dÃ¹ng nhÆ° sau:

let storage = AtomicStorage()
DispatchQueue.concurrentPerform(iterations: 100) { i in
    storage.set(i, value: "\(Thread.current)")
}
print(storage.allValues)
NhÆ° váº­y, báº¡n sáº½ Ä‘Æ°a Thread Safety vÃ o trong má»™t custom class. Nháº±m Ä‘áº£m báº£o má»¥c Ä‘Ã­ch chÃ­nh lÃ  an toÃ n trong cÃ¡c xá»­ lÃ½ Ä‘a luá»“ng.

NgoÃ i ra, báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng .barrier vá»›i má»™t Concurrent Queue thay cho Serial Queue kÃ¬a. (tham kháº£o bÃ i trÆ°á»›c nha)

Atomic Property
Theo trÃªn, báº¡n cÅ©ng Ä‘Ã£ biáº¿t vá»›i Swift thÃ¬ máº·c Ä‘á»‹nh cÃ¡c kiá»ƒu dá»¯ liá»‡u cá»§a nÃ³ lÃ  sáº½ khÃ´ng an toÃ n cho viá»‡c tÆ°Æ¡ng tÃ¡c trong cÃ¡c Thread. VÃ  cÃ¡ch giáº£i quyáº¿t lÃ  táº¡o ra 1 Thread hay custom class vá»›i má»™t Thread Safety.

NhÆ°ng, náº¿u chÃºng ta muá»‘n má»™t cÃ¡ch dÃ¹ng nÃ o Ä‘Ã³ nhanh gá»n láº¹ hÆ¡n, thÃ¬ tháº­t khÃ³. CÃ²n vá»›i ngÃ´n ngá»¯ Objective-C, láº¡i cho phÃ©p chÃºng ta khai bÃ¡o má»™t property/biáº¿n vá»›i tá»« khoÃ¡ lÃ  nonatomic & atomic. Khi vá»›i atomic, biáº¿n cá»§a báº¡n sáº½ chá»‰ Ä‘Æ°á»£c má»™t Thread truy cáº­p vÃ  sá»­a Ä‘á»•i trong má»™t thá»i Ä‘iá»ƒm nháº¥t Ä‘á»‹nh.

CÃ²n Swift, chÃºng ta sáº½ cÃ³ 1 giáº£i phÃ¡p khÃ¡c nhÆ° sau:

Atomic Property = Thread Safety + Property Wrappers

 Khai bÃ¡o
Báº¡n sáº½ sá»­ dá»¥ng tá»›i Property Wrapper Ä‘á»ƒ Ä‘á»‹nh nghÄ©a má»™t struct cho phÃ©p báº¡n sá»­ dá»¥ng má»™t Thread Safety trong nÃ³. Ta sáº½ Ã¡p dá»¥ng DispatchQueue Ä‘á»ƒ lÃ m háº¡t nhÃ¢n xá»­ lÃ½. Báº¡n tham kháº£o code cá»§a nÃ³ nha.

@propertyWrapper
struct Atomic<Value> {
    private let queue = DispatchQueue(label: "atomic")
    private var value: Value
    init(wrappedValue: Value) {
        self.value = wrappedValue
    }
    
    var wrappedValue: Value {
        get {
            return queue.sync { value }
        }
        set {
            queue.sync { value = newValue }
        }
    }
}
Vá» Property Wrappers thÃ¬ mÃ¬nh sáº½ trÃ¬nh bÃ y táº¡i má»™t bÃ i viáº¿t khÃ¡c.

 Sá»­ dá»¥ng
Vá»›i viá»‡c Ä‘á»‹nh nghÄ©a má»™t Property Wrappers, thÃ¬ sá»­ dá»¥ng nÃ³ cÅ©ng khÃ¡ Ä‘Æ¡n giáº£n. Báº¡n chá»‰ cáº§n thÃªm tá»« khoÃ¡ @Atomic (tÃªn cá»§a struct sau @) trong viá»‡c khai bÃ¡o má»™t biáº¿n hay má»™t thuá»™c tÃ­nh báº¥t kÃ¬. Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng nÃ³ vÃ o trong má»™t thuá»™c tÃ­nh cá»§a má»™t class/struct nÃ o Ä‘Ã³ cÅ©ng Ä‘Æ°á»£c.

VÃ­ dá»¥, ta khai bÃ¡o láº¡i biáº¿n sau vá»›i Property Wrappers trÃªn nha. Tham kháº£o code nha.

@Atomic var storage: [Int:String] = [:]
VÃ  chÃºng ta tiáº¿p tá»¥c sá»­ dá»¥ng láº¡i vÃ­ dá»¥ trÃªn cho biáº¿n má»›i Ä‘Ã³.

@Atomic var storage: [Int:String] = [:]
DispatchQueue.concurrentPerform(iterations: 100) { i in
    storage[i] = "\(Thread.current)"
}
print(storage)
Vá»›i cÃ¡ch nÃ y, báº¡n khÃ´ng cáº§n thay Ä‘á»•i gÃ¬ nhiá»u trong code. Báº¡n váº«n Ä‘áº£m báº£o Ä‘Æ°á»£c vá» máº·t hoáº¡t Ä‘á»™ng cá»§a chÆ°Æ¡ng trÃ¬nh vÃ  dá»¯ liá»‡u. BÃªn cáº¡nh Ä‘Ã³ cÃ²n trÃ¡nh Ä‘Æ°á»£c Data Race ná»¯a.
